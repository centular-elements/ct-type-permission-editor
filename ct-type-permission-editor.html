<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-badge/paper-badge.html">

<link rel="import" href="../ct-permissions-api/ct-permissions-api.html">
<link rel="import" href="../ct-resource-types-api/ct-resource-types-api.html">


<!--
`ct-type-permission-editor`
Element for resource type permission editing

@demo demo/index.html
-->

<dom-module id="ct-type-permission-editor">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      paper-material {
        background-color: white;
      }
      .column-header {
        min-width: 250px;
        max-width: 250px;
        border: thick black;
      }
      .some-cell {
        min-width: 250px;
        max-width: 250px;
      }
      .granted {
        --paper-badge-margin-left: -25px;
        --paper-badge-margin-bottom: 0px;
      }
    </style>

    <ct-permissions-api id="permissionsApi"></ct-permissions-api>
    <ct-resource-types-api id="resourceTypesApi"></ct-resource-types-api>

    <paper-dropdown-menu label="Category" selected="0">
      <paper-listbox class="dropdown-content">
        <template is="dom-repeat" items="[[ _categories ]]" as="category">
          <paper-item category="[[ category ]]" on-tap="_categorySelected">[[ category ]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <div class="layout horizontal">
      <paper-material elevation="1">
        <div class="layout horizontal">
          <div class="layout horizontal column-header">
            <div class="layout flex">RESOURCE TYPE</div>
            <div class="layout flex horizontal end-justified">FIELD</div>
          </div>
          <div class="layout horizontal column-header">
            <div class="layout flex horizontal center-justified">CREATE</div>
            <div class="layout flex horizontal center-justified">READ</div>
            <div class="layout flex horizontal center-justified">UPDATE</div>
            <div class="layout flex horizontal center-justified">DELETE</div>
          </div>
        </div>
        <template is="dom-repeat" items="[[ _resourceTypes ]]" as="resourceType">
          <div class="layout horizontal">
            <div class="some-cell">[[ resourceType.name ]]</div>
            <div class="layout horizontal some-cell">
              <div class="layout flex horizontal center-justified">
                <paper-icon-button icon="icons:check-circle" on-tap="_permissionTapped" permission-type="create"></paper-icon-button>
                <paper-badge class="granted" icon="icons:check" label="granted"></paper-badge>
                <paper-badge icon="icons:block" label="denied"></paper-badge>
              </div>
              <div class="layout flex horizontal center-justified">
                <paper-icon-button icon="icons:cancel" on-tap="_permissionTapped" permission-type="read"></paper-icon-button>
              </div>
              <div class="layout flex horizontal center-justified">
                <paper-icon-button icon="icons:radio-button-checked" on-tap="_permissionTapped" permission-type="update"></paper-icon-button>
              </div>
              <div class="layout flex horizontal center-justified">
                <paper-icon-button icon="icons:radio-button-unchecked" on-tap="_permissionTapped" permission-type="delete"></paper-icon-button>
              </div>
            </div>
          </div>
          <template is="dom-repeat" items="[[ resourceType.fields ]]" as="field">
            <div class="layout horizontal">
              <div class="layout horizontal end-justified some-cell">[[ field ]]</div>
              <div class="layout horizontal some-cell">
                <paper-icon-button icon="icons:check-circle"></paper-icon-button>
                <paper-icon-button icon="icons:cancel"></paper-icon-button>
                <paper-icon-button icon="icons:radio-button-checked"></paper-icon-button>
                <paper-icon-button icon="icons:radio-button-unchecked"></paper-icon-button>
              </div>
            </div>
          </template>
        </template>
      </paper-material>

      <paper-material elevation="1">

      </paper-material>
    </div>


  </template>

  <script>
    Polymer({

      is: 'ct-type-permission-editor',

      properties: {
        subjectId: String,
        subjectResourceTypeId: String
      },

      observers: [
        '_getResourceTypePermissions(subjectId, subjectResourceTypeId)'
      ],

      ready: function() {
        this.$.resourceTypesApi.findResourceTypes()
                .then(function (request) {
                  this._resourceTypes = request.response;
                  this._categories = Array.from(new Set(this._resourceTypes.map(function(resourceType) {
                    return resourceType.category;
                  })));
                  console.log('done');
                }.bind(this))
                .catch(function (error) {
                }.bind(this));
      },

      _getResourceTypePermissions: function() {
        this.$.permissionsApi.getResourceTypeAccess(this.subjectId, this.subjectResourceTypeId)
                .then(function (request) {
                  this._resourceTypePermissions = request.response;
                  console.log('done');
                }.bind(this))
                .catch(function (error) {
                }.bind(this));
      },



      _categorySelected: function(e) {

      },

      _viewResourceTypes(category) {

      },

      _calculateResourceTypePermissionIcon(action, resourceType) {
        var permissions = this._resourceTypePermissions.find(function(rtp) {
          return rtp.toResourceType.id == resourceType && rtp.givenBy.id == this.subjectId;
        });

        var inheritedPermissions = this._resourceTypePermissions.find(function(rtp) {
          return rtp.toResourceType.id == resourceType && rtp.givenBy.id != this.subjectId;
        });



        if (permissions.length > 0 && permissions[0].access == "GRANTED") {
          var permittedAction = permissions[0].permission & action;
          if (permittedAction == action) {

          }
        }
      }

    });
  </script>
</dom-module>
