<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-badge/paper-badge.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-icon-item.html">

<link rel="import" href="../ct-permissions-api/ct-permissions-api.html">
<link rel="import" href="../ct-resource-types-api/ct-resource-types-api.html">
<link rel="import" href="ct-permission-toggle.html">



<!--
`ct-type-permission-editor`
Element for resource type permission editing

@demo demo/index.html
-->

<dom-module id="ct-type-permission-editor">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      paper-material {
        background-color: white;
      }
      .resource-type-column-header {
        border-width: thick;
        padding: 10px;
        min-width: 150px;
      }
      .permissions-column-header {
        padding: 10px;
        min-width: 300px;
      }
      .resource-type-cell {
        min-width: 150px;
      }
      .field-cell {
        min-width: 120px;
        font-style: italic;
        padding-left: 30px;
      }
      .permission-cell {
        min-width: 300px;
      }
      .row {
        --paper-item-focused-before: {
          background-color: transparent;
        }
      }
      .row:hover {
        background: lightgray;
      }
    </style>

    <ct-permissions-api id="permissionsApi"></ct-permissions-api>

    <paper-material elevation="1">
      <paper-item class="row">
        <div class="resource-type-cell">
          [[ resourceType.name ]]
        </div>
        <ct-permission-toggle id="typeToggle" granted-value="[[ _grantedValue ]]" denied-value="[[ _deniedValue ]]"></ct-permission-toggle>
      </paper-item>
    </paper-material>
    <paper-material>
      <template is="dom-repeat" items="[[ resourceType.fields ]]" as="field">
        <paper-item class="row">
          <div class="field-cell">
            [[ field ]]
          </div>
          <ct-permission-toggle id="fieldToggle[[ field ]]" granted-value="0" denied-value="0"></ct-permission-toggle>
        </paper-item>
      </template>
    </paper-material>



<!--
      <paper-material class="layout vertical" elevation="1">
        <span>[[ _actionToText(_selectedAction) ]] [[ _selectedResourceTypeName ]] [[ _selectedFieldName ]]</span>
        <template is="dom-repeat" items="[[ _selectedPermissionDetail ]]" as="perm">
          <span>[[ perm.access ]] by [[ perm.givenBy ]]</span>
        </template>
        <div class="layout horizontal centre-justified">
          <paper-button>Granted</paper-button>
          <paper-button>Denied</paper-button>
          <paper-button>Cleared/Inherited</paper-button>
        </div>
      </paper-material>
-->


  </template>

  <script>
    Polymer({

      is: 'ct-type-permission-editor',

      properties: {
        /**
         * The subject who's permissions you want to edit
         * {id: String, resourceTypeId: String}
         */
        subject: Object,

        /**
         * The resource type on which to apply permission for the subject
         * {id: String, name: String, systemTypeId: String }
         */
        resourceType: Object
      },

      listeners: {
        'ct-apply-permission':'_applyPermission'
      },

      observers: [
        '_fetchPermissions(subject, resourceType)'
      ],

      _fetchPermissions: function() {
        this.$.permissionsApi.viewResourceTypePermissions(this.subject, { id: this.resourceType.id, systemTypeId: this.resourceType.systemTypeId })
                .then(function (request) {
                  this._permissions = this._filterSubjectPermissions(request.response);
                  this._grantedValue = this._getGranted(this._permissions).permission.permission;
                  this._deniedValue = this._getDenied(this._permissions).permission.permission;
                  this._inheritedPermissions = this._filterInheritedPermissions(request.response);
                }.bind(this))
                .catch(function (error) {
                }.bind(this));
      },

      _getGranted: function(permissions) {
        var granted = permissions.find(function(p) {
          return p.permission.access == 'GRANTED';
        });
        return granted ? granted : { permission: { access: "GRANTED", permission: 0 }, givenBy: this.subject }
      },

      _getDenied: function(permissions) {
        var denied = permissions.find(function(p) {
          return p.permission.access == 'DENIED';
        });
        return denied ? denied : { permission: { access: "DENIED", permission: 0 }, givenBy: this.subject }
      },


      _filterSubjectPermissions: function(permissions) {
        return permissions.filter(function(p) {
          return p.givenBy.id == this.subject.id;
        }.bind(this))
      },

      _filterInheritedPermissions: function(permissions) {
        return permissions.filter(function(p) {
          return p.givenBy.id != this.subject.id;
        }.bind(this))
      },

      _mapPermissionsForIndication: function(resourceType) {
        var permissions = this._filterSubjectPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          return {
            access: p.permission.access,
            value: p.permission.permission
          }
        });

        return permissions == null ? [] : permissions
      },

      _mapInheritedForIndication: function(resourceType) {
        var permissions = this._filterInheritedPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          return {
            access: p.permission.access,
            value: p.permission.permission
          }
        });

        return permissions == null ? [] : permissions
      },

      _mapFieldPermissionsForIndication: function(resourceType, field) {
        var permissions = this._filterSubjectPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          var fieldPermission = p.permission.fieldPermissions.find(function(fp) {
            return fp.name == field;
          });
          return {
            access: p.permission.access,
            value: fieldPermission ? fieldPermission.permission : 0
          }
        });

        return permissions == null ? [] : permissions
      },

      _mapInheritedFieldPermissionsForIndication: function(resourceType, field) {
        var permissions = this._filterInheritedPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          var fieldPermission = p.permission.fieldPermissions.find(function(fp) {
            return fp.name == field;
          });
          return {
            access: p.permission.access,
            value: fieldPermission ? fieldPermission.permission : 0
          }
        });

        return permissions == null ? [] : permissions
      },

      _permissionSelected: function(e, detail) {
        var spl = detail.split(',');
        if (spl.length > 2) {
          this._selectedPermissionDetail = this._getSelectedPermissionDetail(spl[0], spl[1], spl[2]);
          this._selectedFieldName = spl[1];
          this._selectedAction = spl[2];
        } else {
          this._selectedPermissionDetail = this._getSelectedPermissionDetail(spl[0], null, spl[1]);
          this._selectedFieldName = '';
          this._selectedAction = spl[1];
        }
        this._selectedResourceTypeName = this._resourceTypes.find(function(t) {
          return t.id == spl[0]
        }).name;
      },

      _getSelectedPermissionDetail: function(selectedResourceTypeId, selectedField, selectedAction) {
        if (selectedField) {
          var permissions = this._filterInheritedPermissions(this._filterResourceTypePermissions(selectedResourceTypeId)).filter(function(p) {
            var fieldPermission = p.permission.fieldPermissions.find(function(fp) {
              return fp.name == selectedField;
            });
            return fieldPermission ? (fieldPermission.permission & selectedAction) == selectedAction : false;
          }).map(function(p) {
            return {
              access: p.permission.access,
              givenBy: p.givenBy.name
            }
          });

          return permissions == null ? [] : permissions
        }
      },

      _actionToText: function(action) {
        if (action == 1) {
          return 'Create'
        }
        if (action == 2) {
          return 'Read'
        }
        if (action == 4) {
          return 'Update'
        }
        if (action == 8) {
          return 'Delete'
        }
      },

      _applyPermission: function(e, detail) {
        console.log(e.srcElement.id);
        console.log(detail);
      }

    });
  </script>
</dom-module>
