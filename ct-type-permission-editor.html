<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-badge/paper-badge.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-icon-item.html">

<link rel="import" href="../ct-permissions-api/ct-permissions-api.html">
<link rel="import" href="../ct-resource-types-api/ct-resource-types-api.html">
<link rel="import" href="ct-permission-indicator.html">



<!--
`ct-type-permission-editor`
Element for resource type permission editing

@demo demo/index.html
-->

<dom-module id="ct-type-permission-editor">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      paper-material {
        background-color: white;
      }
      .resource-type-column-header {
        border-width: thick;
        padding: 10px;
        min-width: 150px;
      }
      .permissions-column-header {
        padding: 10px;
        min-width: 300px;
      }
      .resource-type-cell {
        min-width: 150px;
      }
      .field-cell {
        min-width: 120px;
        font-style: italic;
        padding-left: 30px;
      }
      .permission-cell {
        min-width: 300px;
      }
      .row {
        border: medium black;
        --paper-item-focused-before: {
          background-color: transparent;
        }
      }
      .row:hover {
        background: lightgray;
      }
    </style>

    <ct-permissions-api id="permissionsApi"></ct-permissions-api>
    <ct-resource-types-api id="resourceTypesApi"></ct-resource-types-api>

    <paper-dropdown-menu label="Category" selected="0">
      <paper-listbox class="dropdown-content">
        <template is="dom-repeat" items="[[ _categories ]]" as="category">
          <paper-item category="[[ category ]]" on-tap="_categorySelected">[[ category ]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <div class="layout horizontal">
      <paper-material elevation="1">
        <div class="layout horizontal">
          <div class="layout horizontal resource-type-column-header">
            <span class="layout flex">RESOURCE TYPE</span>
          </div>
          <div class="layout horizontal permissions-column-header">
            <div class="layout flex horizontal center-justified">CREATE</div>
            <div class="layout flex horizontal center-justified">READ</div>
            <div class="layout flex horizontal center-justified">UPDATE</div>
            <div class="layout flex horizontal center-justified">DELETE</div>
          </div>
        </div>
        <template is="dom-if" if="[[ _resourceTypePermissions ]]" as="resourceType">
          <template is="dom-repeat" items="[[ _resourceTypes ]]" as="resourceType">
            <paper-item class="row">
              <div class="resource-type-cell">
                [[ resourceType.name ]]
              </div>
              <ct-permission-indicator class="permission-cell"
                                       permissions="[[ _mapPermissionsForIndication(resourceType) ]]"
                                       inherited-permissions="[[ _mapInheritedForIndication(resourceType) ]]"
                                       identifier="[[ resourceType.id ]]"
              ></ct-permission-indicator>
            </paper-item>
            <template is="dom-repeat" items="[[ resourceType.fields ]]" as="field">
              <paper-item class="row">
                <div class="field-cell">
                  [[ field ]]
                </div>
                <ct-permission-indicator class="permission-cell"
                                         permissions="[[ _mapFieldPermissionsForIndication(resourceType, field) ]]"
                                         inherited-permissions="[[ _mapInheritedFieldPermissionsForIndication(resourceType, field) ]]"
                                         identifier="[[ resourceType.id]],[[ field ]]"
                ></ct-permission-indicator>
              </paper-item>
            </template>
          </template>
        </template>
      </paper-material>

      <paper-material class="layout vertical" elevation="1">
        <span>[[ _actionToText(_selectedAction) ]] [[ _selectedResourceTypeName ]] [[ _selectedFieldName ]]</span>
        <template is="dom-repeat" items="[[ _selectedPermissionDetail ]]" as="perm">
          <span>[[ perm.access ]] by [[ perm.givenBy ]]</span>
        </template>
        <div class="layout horizontal centre-justified">
          <paper-button>Granted</paper-button>
          <paper-button>Denied</paper-button>
          <paper-button>Cleared/Inherited</paper-button>
        </div>
      </paper-material>
    </div>


  </template>

  <script>
    Polymer({

      is: 'ct-type-permission-editor',

      properties: {
        subjectId: String,
        subjectResourceTypeId: String
      },

      listeners: {
        'ct-permission-selected':'_permissionSelected'
      },

      observers: [
        '_getResourceTypePermissions(subjectId, subjectResourceTypeId)'
      ],

      ready: function() {
        this.$.resourceTypesApi.findResourceTypes()
                .then(function (request) {
                  this._resourceTypes = request.response;
                  this._categories = Array.from(new Set(this._resourceTypes.map(function(resourceType) {
                    return resourceType.category;
                  })));
                  console.log('done');
                }.bind(this))
                .catch(function (error) {
                }.bind(this));
      },

      _getResourceTypePermissions: function() {
        this.$.permissionsApi.getResourceTypeAccess(this.subjectId, this.subjectResourceTypeId)
                .then(function (request) {
                  this._resourceTypePermissions = request.response;
                  console.log('done');
                }.bind(this))
                .catch(function (error) {
                }.bind(this));
      },

      _categorySelected: function(e) {

      },

      _viewResourceTypes(category) {

      },

      _filterResourceTypePermissions: function(resourceTypeId) {
        return this._resourceTypePermissions.filter(function(p) {
          return p.toResourceType.id == resourceTypeId;
        })
      },

      _filterSubjectPermissions: function(permissions) {
        return permissions.filter(function(p) {
          return p.givenBy.id == this.subjectId;
        }.bind(this))
      },

      _filterInheritedPermissions: function(permissions) {
        return permissions.filter(function(p) {
          return p.givenBy.id != this.subjectId;
        }.bind(this))
      },

      _mapPermissionsForIndication: function(resourceType) {
        var permissions = this._filterSubjectPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          return {
            access: p.permission.access,
            value: p.permission.permission
          }
        });

        return permissions == null ? [] : permissions
      },

      _mapInheritedForIndication: function(resourceType) {
        var permissions = this._filterInheritedPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          return {
            access: p.permission.access,
            value: p.permission.permission
          }
        });

        return permissions == null ? [] : permissions
      },

      _mapFieldPermissionsForIndication: function(resourceType, field) {
        var permissions = this._filterSubjectPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          var fieldPermission = p.permission.fieldPermissions.find(function(fp) {
            return fp.name == field;
          });
          return {
            access: p.permission.access,
            value: fieldPermission ? fieldPermission.permission : 0
          }
        });

        return permissions == null ? [] : permissions
      },

      _mapInheritedFieldPermissionsForIndication: function(resourceType, field) {
        var permissions = this._filterInheritedPermissions(this._filterResourceTypePermissions(resourceType.id)).map(function(p) {
          var fieldPermission = p.permission.fieldPermissions.find(function(fp) {
            return fp.name == field;
          });
          return {
            access: p.permission.access,
            value: fieldPermission ? fieldPermission.permission : 0
          }
        });

        return permissions == null ? [] : permissions
      },

      _permissionSelected: function(e, detail) {
        var spl = detail.split(',');
        if (spl.length > 2) {
          this._selectedPermissionDetail = this._getSelectedPermissionDetail(spl[0], spl[1], spl[2]);
          this._selectedFieldName = spl[1];
          this._selectedAction = spl[2];
        } else {
          this._selectedPermissionDetail = this._getSelectedPermissionDetail(spl[0], null, spl[1]);
          this._selectedFieldName = '';
          this._selectedAction = spl[1];
        }
        this._selectedResourceTypeName = this._resourceTypes.find(function(t) {
          return t.id == spl[0]
        }).name;
      },

      _getSelectedPermissionDetail: function(selectedResourceTypeId, selectedField, selectedAction) {
        if (selectedField) {
          var permissions = this._filterInheritedPermissions(this._filterResourceTypePermissions(selectedResourceTypeId)).filter(function(p) {
            var fieldPermission = p.permission.fieldPermissions.find(function(fp) {
              return fp.name == selectedField;
            });
            return fieldPermission ? (fieldPermission.permission & selectedAction) == selectedAction : false;
          }).map(function(p) {
            return {
              access: p.permission.access,
              givenBy: p.givenBy.name
            }
          });

          return permissions == null ? [] : permissions
        }
      },

      _actionToText: function(action) {
        if (action == 1) {
          return 'Create'
        }
        if (action == 2) {
          return 'Read'
        }
        if (action == 4) {
          return 'Update'
        }
        if (action == 8) {
          return 'Delete'
        }
      }

    });
  </script>
</dom-module>
